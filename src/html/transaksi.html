<section class="section main-section">
  <div class="card">
    <header class="card-header">
      <p class="card-header-title">
        <span class="icon"><i class="mdi mdi-cart"></i></span>
        Form Transaksi
      </p>
    </header>
    <div class="card-content">
      <form id="formTransaksi">
        <div class="field">
          <label class="label">Jenis Transaksi</label>
          <div class="control">
            <div class="select">
              <select name="jenis" required>
                <option value="keluar">keluar</option>
                <option value="masuk">masuk</option>
              </select>
            </div>
          </div>
        </div>

        <div class="field">
          <label class="label">Keterangan</label>
          <div class="control">
            <div class="select">
              <select name="keterangan" required>
                <option value="reseller">Reseller</option>
                <option value="costumer">Costumer</option>
                <option value="suplier">Suplier</option>
              </select>
            </div>
          </div>
        </div>

        <hr>
        <label class="label">Detail Barang</label>
        <div id="barang-container"></div>

        <div class="field">
          <button type="button" class="button small green" onclick="tambahBarang()">+ Tambah Barang</button>
          <button type="button" class="button small is-info" onclick="mulaiScan()">üì∑ Scan QR</button>
          <button type="button" class="button small is-danger" onclick="tutupScan()">‚úñÔ∏è Tutup Kamera</button>

        </div>

        <select id="cameraSelect"></select>
        <div id="qr-reader" style="width: 300px; margin-top: 1rem;"></div>

        <hr>
        <div class="field grouped">
          <div class="control">
            <button type="submit" class="button green">Proses Transaksi</button>
          </div>
          <div class="control">
            <button type="button" class="button red" onclick="resetFormTransaksi()">Reset</button>
          </div>
        </div>
      </form>
    </div>
  </div>
</section>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

<!-- fungsi scan dan tambah barang -->
<script>
  let currentCameraId = null;
  let html5QrCode;
  let barangTerakhir = null;
  let barangIndex = 0;

  function mulaiScan() {
    const qrDiv = document.getElementById("qr-reader");
    if (!html5QrCode) {
      html5QrCode = new Html5Qrcode("qr-reader");
    }

    if (!currentCameraId) {
      alert("Pilih kamera terlebih dahulu.");
      return;
    }

    html5QrCode.start(
      currentCameraId,
      {
        fps: 10,
        qrbox: 250
      },
      qrCodeMessage => {
        try {
          let barang_id = null;
          let harga = null;

          // Coba dulu parse sebagai JSON
          try {
            const data = JSON.parse(qrCodeMessage);
            barang_id = data.barang_id;
            harga = data.harga;
          } catch (e) {
            // Kalau gagal, coba parsing manual dari teks
            const lines = qrCodeMessage.split('\n');
            lines.forEach(line => {
              if (line.toLowerCase().includes("id:")) {
                barang_id = parseInt(line.split(':')[1].trim());
              } else if (line.toLowerCase().includes("harga:")) {
                const hargaStr = line.split(':')[1].replace(/[^\d]/g, '');
                harga = parseInt(hargaStr);
              }
            });
          }

          if (barang_id && harga) {
            if (barangTerakhir) {
              barangTerakhir.querySelector("input[name='barang_id']").value = barang_id;
              barangTerakhir.querySelector("input[name='harga']").value = harga;
              alert("Scan berhasil untuk ID: " + barang_id);
              barangTerakhir = null;
            }
          } else {
            alert("QR tidak valid atau data tidak lengkap.");
          }

        } catch (err) {
          alert("Gagal memproses QR Code");
        }
      },
      errorMessage => {
        // abaikan error scanning
      }
    );
  }


  function initCameraOptions() {
    Html5Qrcode.getCameras().then(cameras => {
      if (cameras && cameras.length) {
        const select = document.getElementById("cameraSelect");
        select.innerHTML = "";

        cameras.forEach(camera => {
          const option = document.createElement("option");
          option.value = camera.id;
          option.text = camera.label || `Kamera ${select.length + 1}`;
          select.appendChild(option);
        });

        currentCameraId = cameras[0].id;
      } else {
        alert("Tidak ada kamera ditemukan.");
      }
    }).catch(err => {
      alert("Gagal mengambil kamera: " + err);
    });
  }


  document.getElementById("cameraSelect").addEventListener("change", function () {
    currentCameraId = this.value;
  });

  window.addEventListener("load", initCameraOptions);



  function tambahBarang() {
    const container = document.getElementById('barang-container');

    const row = document.createElement('div');
    row.className = 'field is-grouped mb-2';
    row.setAttribute('data-index', barangIndex);

    row.innerHTML = `
      <div class="control is-expanded">
        <input type="number" class="input" min="0" name="barang_id" placeholder="ID Barang" required>
      </div>
      <div class="control">
        <input type="number" min="0" class="input" name="jumlah" placeholder="Jumlah" required>
      </div>
      <div class="control">
        <input type="number" min="0" class="input" name="harga" placeholder="Harga" required>
      </div>
      <div class="control">
        <button type="button" class="button is-danger" onclick="this.closest('.field').remove()">Hapus</button>
      </div>
    `;

    container.appendChild(row);
    barangTerakhir = row;
    barangIndex++;
  }



  function resetFormTransaksi() {
    // Stop kamera jika aktif
    if (html5QrCode && html5QrCode._isScanning) {
      html5QrCode.stop().then(() => {
        document.getElementById("qr-reader").innerHTML = "";
      }).catch(err => {
        console.warn("Gagal stop kamera saat reset:", err);
      });
    }

    // Reset form
    document.getElementById("formTransaksi").reset();

    // Kosongkan detail barang
    document.getElementById("barang-container").innerHTML = "";
    barangIndex = 0;
    barangTerakhir = null;
  }


  function tutupScan() {
    if (html5QrCode) {
      html5QrCode.stop().then(() => {
        document.getElementById("qr-reader").innerHTML = "";
      }).catch(err => {
        console.error("Gagal menutup kamera:", err);
      });
    }
  }

</script>

<!-- fungsi transaksi -->
<script>
  document.getElementById("formTransaksi").addEventListener("submit", async function (e) {
    e.preventDefault();

    const jenis = this.jenis.value;
    const keterangan = this.keterangan.value;

    const barangList = [];
    const container = document.getElementById("barang-container");
    const rows = container.querySelectorAll(".field[data-index]");

    rows.forEach(row => {
      const barang_id = row.querySelector("input[name='barang_id']").value;
      const jumlah = row.querySelector("input[name='jumlah']").value;
      const harga = row.querySelector("input[name='harga']").value;

      if (barang_id && jumlah && harga) {
        barangList.push({
          barang_id: parseInt(barang_id),
          jumlah: parseInt(jumlah),
          harga: parseInt(harga)
        });
      }
    });

    if (barangList.length === 0) {
      alert("Tambahkan minimal 1 barang!");
      return;
    }

    const data = {
      jenis,
      keterangan,
      detail: barangList
    };

    try {
      const res = await fetch(`${API_URL}/transaksi`, {
        method: "POST",
        credentials: 'include',
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify(data)
      });

      const result = await res.json();

      if (res.ok) {
        alert("Transaksi berhasil disimpan!");
        resetFormTransaksi();
      } else {
        alert("Gagal: " + (result.message || "Terjadi kesalahan."));
      }

    } catch (error) {
      console.error(error);
      alert("Terjadi kesalahan jaringan.");
    }
  });
</script>